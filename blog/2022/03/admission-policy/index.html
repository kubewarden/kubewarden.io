<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Introducing the AdmissionPolicy</title><link rel=icon type=image/svg href=/favicon.svg><link rel=mask-icon href=/favicon.svg><link rel=stylesheet type=text/css href=/sass/blog.min.css?1652361238><script async defer src=https://buttons.github.io/buttons.js></script><script type=text/javascript src=//cdn.bizible.com/scripts/bizible.js async></script></head><body><header><div class=sub-header><a href><img src=/images/logo-kubewarden.svg alt=Kubewarden></a>
<a href=#main-menu id=main-menu-toggle class=menu-toggle aria-label="Open main menu"><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><nav id=main-menu class=main-menu aria-label="Main menu"><a href=#main-menu-toggle id=main-menu-close class=menu-close aria-label="Close main menu"><span class=sr-only>Close main menu</span>
<span class="fa fa-close" aria-hidden=true></span></a><h2 id=main-menu-heading class=sr-only>Main menu</h2><ul class=menu><li><a href=https://hub.kubewarden.io/ target=_blank class="btn no-bg">Policy Hub</a></li><li><a href=https://charts.kubewarden.io/ target=_blank class="btn no-bg">Helm Charts</a></li><li><a href=https://docs.kubewarden.io/ target=_blank class="btn no-bg">Docs</a></li><li><a href="https://kubernetes.slack.com/?redir=%2Fmessages%2Fkubewarden" target=_blank class="btn no-bg">Slack</a></li><li><a href=https://twitter.com/kubewarden target=_blank class="btn no-bg">Twitter</a></li><li><a href=https://kubewarden.io/blog target=_blank class="btn no-bg">Blog</a></li><li><a href=https://github.com/kubewarden class="btn github"><img src=/images/icon-github.svg><span>Github</span></a></li></ul></nav><a href=#main-menu-toggle class=backdrop tabindex=-1 aria-hidden=true hidden></a></div></header><link rel=stylesheet href=/css/blog.css><section class=intro><div class=bg-primary><div class="wrap grid-one"><div><h1 style=color:#fff><a href=/blog>The Kubewarden blog</a>
<a href=/blog/index.xml><img src=/images/icon-rss.svg class=fill-white height=20></a></h1></div></div></div></section><main><section class=wrap><article><h1>Introducing the AdmissionPolicy</h1><p>Author: <author>Raul Cabello Martin</author></p><p>Published: <time>16 Mar 2022</time></p><p>Updated: <time>12 May 2022</time></p><div id=blog-post-content><p>Up till now, the only way to define a policy in Kubewarden was to use the <a href=https://github.com/kubewarden/kubewarden-controller/blob/main/docs/crds/README.asciidoc#k8s-api-github-com-kubewarden-kubewarden-controller-apis-policies-v1alpha2-clusteradmissionpolicy><code>ClusterAdmissionPolicy</code></a> resource that would be applied to cluster-wide resources across all namespaces.</p><p>That&rsquo;s why we&rsquo;re thrilled to announce the new <code>AdmissionPolicy</code> resource. This new resource is created inside a <code>namespace</code> and the policies will only process the requests that are targeting the namespace where the <code>AdmissionPolicy</code> is defined. Except from being a &ldquo;namespaced&rdquo; resource, <code>AdmissionPolicy</code> works exactly the same as the <code>ClusterAdmissionPolicy</code>.</p><h2 id=why-should-you-use-admissionpolicies>Why should you use AdmissionPolicies?</h2><p>It was possible to restrict the namespaces where a <code>ClusterAdmissionPolicy</code> evaluated resources using a <a href=https://github.com/kubewarden/kubewarden-controller/blob/main/docs/crds/README.asciidoc#clusteradmissionpolicyspec><code>namespaceSelector</code></a>. However there was no way for Kubernetes administrators to restrict users from creating <code>ClusterAdmissionPolicies</code> that evaluate resources just in a particular namespace.</p><p>Moreover, allowing all tenants to deploy <code>ClusterAdmissionPolicies</code> is risky. A tenant could apply policies that affect resources in all namespaces, even if they don&rsquo;t have access to all of them.
Which is why, as a Kubernetes administrator, you probably want to allow tenants to deploy policies only in the namespaces they have access to. That&rsquo;s where <code>AdmissionPolicies</code> come into play! <code>AdmissionPolicies</code> combined with <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>Role-Based Access Control (RBAC) in Kubernetes</a> allow you to enforce this restriction by delimiting the tenants to deploy resources only across namespaces they have access to.</p><p>As an example, let&rsquo;s say you want a tenant who can deploy resources just to the <code>development</code> namespace. You can allow this tenant to deploy <code>AdmissionPolicies</code> just in this namespace using RBAC. However, if you allowed them to create <code>ClusterAdmissionPolicies</code>, they could block other resources from being handled in other namespaces.</p><h2 id=admissionpolicy-in-action>AdmissionPolicy in Action!</h2><p>Let&rsquo;s create an <code>AdmissionPolicy</code> that rejects privileged pods from being created in the <code>production</code> namespace.
For this example, a Kubernetes cluster with Kubewarden already installed is required. The installation process is described in the <a href=https://docs.kubewarden.io/quick-start.html>quick start guide</a>.</p><p>First, create two namespaces: <code>development</code> and <code>production</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>kubectl create ns development 
kubectl create ns production
</code></pre></div><p>Once the namespaces are created, create a new <code>AdmissionPolicy</code> resource in the <code>production</code> namespace:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>policies.kubewarden.io/v1alpha2</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AdmissionPolicy</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ns-privileged-pods</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>production</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>module</span>: <span style=color:#ae81ff>registry://ghcr.io/kubewarden/policies/pod-privileged:v0.1.9</span>
  <span style=color:#f92672>rules</span>:
  - <span style=color:#f92672>apiGroups</span>: [<span style=color:#e6db74>&#34;&#34;</span>]
    <span style=color:#f92672>apiVersions</span>: [<span style=color:#e6db74>&#34;v1&#34;</span>]
    <span style=color:#f92672>resources</span>: [<span style=color:#e6db74>&#34;pods&#34;</span>]
    <span style=color:#f92672>operations</span>:
    - <span style=color:#ae81ff>CREATE</span>
  <span style=color:#f92672>mutating</span>: <span style=color:#66d9ef>false</span>

</code></pre></div><p>Wait for the policy to be active:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>kubectl wait --for=condition=PolicyActive admissionpolicies ns-privileged-pods -n production
</code></pre></div><p>Create a file named <code>privileged-pod.yaml</code> with the following pod specification:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>privileged-pod</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>containers</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx:latest</span>
      <span style=color:#f92672>securityContext</span>:
        <span style=color:#f92672>privileged</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><p>Try to create a privileged pod in the <code>production</code> namespace:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>kubectl apply -f privileged-pod.yaml -n production
</code></pre></div><p>You will get the following error:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Error from server: error when creating &#34;privileged-pod.yaml&#34;: admission webhook &#34;namespaced-kubewarden-privileged-pods.kubewarden.admission&#34; denied the request: User &#39;my-user&#39; cannot schedule privileged containers
</code></pre></div><p>Finally, verify you can successfully create a privileged pod in a different namespace:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>kubectl apply -f privileged-pod.yaml -n development
</code></pre></div><h2 id=conclusion>Conclusion</h2><p>As evidenced in the above example, Kubewarden provides you with two different choices for deploying policies.</p><p>If your policy needs to be applied to resources across all namespaces or cluster-wide resources, then you can use <code>ClusterAdmissionPolicies</code>.</p><p>On the other hand, if your cluster is shared by multiple users or teams, uses different namespaces or your policy needs to be applied only to resources within a namespace, then the new <code>AdmissionPolicy</code> would be the right choice.</p><p>You can find the <code>AdmissionPolicy</code> specification <a href=https://github.com/kubewarden/kubewarden-controller/blob/e0433fc3774d06dcf5e08bf2c600ad0117b89448/docs/crds/README.asciidoc#admissionpolicy>here</a>.</p><p>As a community, we thrive on feedback and welcome your suggestions! Feel free to open an issue against our
<a href=https://github.com/kubewarden/kubewarden-controller>GitHub repository</a> or get in
touch on the <a href=https://kubernetes.slack.com/archives/C01T3GTC3L7>#kubewarden Slack channel</a>!</p></div><div><ul id=tags></ul></div><div></div></article></section></main><footer><p>&copy; 2022 SUSE. Kubewarden is an open source project of the <a href=https://suse.com>SUSE</a>
<a href=https://rancher.com>Rancher</a> Engineering group.</p><div class=project-icons><a href=https://k3s.io target=blank><img src=/images/icon-k3s.svg height=20></a>
<a href=https://harvesterhci.io target=blank><img src=/images/icon-harvester.svg height=20></a>
<a href=https://rancherdesktop.io target=blank><img src=/images/icon-rancher-desktop.svg height=20></a>
<a href=https://epinio.io target=blank><img src=/images/icon-epinio.svg height=20></a>
<a href=https://hypper.io target=blank><img src=/images/icon-hypper.svg height=20></a></div></footer><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-56382716-13','auto'),ga('set','anonymizeIp',!0),ga('send','pageview'))</script></body></html>