<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Migrate your PSPs to Kubewarden policies!</title><link rel=icon type=image/svg href=/favicon.svg><link rel=mask-icon href=/favicon.svg><link rel=stylesheet type=text/css href=/sass/blog.min.css?1734604580><script async defer src=https://buttons.github.io/buttons.js></script><script type=text/javascript src=//cdn.bizible.com/scripts/bizible.js async></script></head><body><header><div class=sub-header><a href><img src=/images/logo-kubewarden.svg alt=Kubewarden></a>
<a href=#main-menu id=main-menu-toggle class=menu-toggle aria-label="Open main menu"><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><nav id=main-menu class=main-menu aria-label="Main menu"><a href=#main-menu-toggle id=main-menu-close class=menu-close aria-label="Close main menu"><span class=sr-only>Close main menu</span>
<span class="fa fa-close" aria-hidden=true></span></a><h2 id=main-menu-heading class=sr-only>Main menu</h2><ul class=menu><li><a href="https://artifacthub.io/packages/search?kind=13&sort=relevance&page=1" target=_blank class="btn no-bg">Policies</a></li><li><a href=https://charts.kubewarden.io/ target=_blank class="btn no-bg">Helm Charts</a></li><li><a href=https://docs.kubewarden.io/ target=_blank class="btn no-bg">Docs</a></li><li><a href="https://kubernetes.slack.com/?redir=%2Fmessages%2Fkubewarden" target=_blank class="btn no-bg">Slack</a></li><li><a href=https://twitter.com/kubewarden target=_blank class="btn no-bg">Twitter</a></li><li><a href=/#get-in-touch target=_blank class="btn no-bg">Community</a></li><li><a href=/blog target=_blank class="btn no-bg">Blog</a></li><li><a href=https://github.com/kubewarden class="btn github"><img src=/images/icon-github.svg><span>Github</span></a></li></ul></nav><a href=#main-menu-toggle class=backdrop tabindex=-1 aria-hidden=true hidden></a></div></header><link rel=stylesheet href=/css/blog.css><section class=intro><div class=bg-primary><div class="wrap grid-one"><div><h1 style=color:#fff><a href=/blog>The Kubewarden blog</a>
<a href=/blog/index.xml><img src=/images/icon-rss.svg class=fill-white height=20></a></h1></div></div></div></section><main><section class=wrap><article><h1>Migrate your PSPs to Kubewarden policies!</h1><p>Author: <author>Jos√© Guilherme Vanz</author></p><p>Published: <time>13 Jul 2022</time></p><p>Updated: <time>19 Dec 2024</time></p><div id=blog-post-content><blockquote><p>Warning: the code snippets shown inside of this blog post have become
outdated. For up-to-date information checkout
<a href=https://docs.kubewarden.io/tasksDir/psp-migration>this</a> section of the
Kubewarden documentation.</p></blockquote><p>As announced in past blog posts, Kubewarden has 100% coverage of the deprecated,
and soon to be removed, Kubernetes PSPs. If everything goes as expected the PSPs will
be removed in Kubernetes v1.25 due for release on 23rd August 2022.</p><p>The Kubewarden team has written a script that leverages the migration tool written
by <a href=https://github.com/appvia/psp-migration>AppVia</a>, to migrate PSP
automatically. The tool is capable of reading PSPs YAML and can generate the equivalent
policies in many different policy engines. Our simple script migrates
your PSPs to their equivalent Kubewarden policies.</p><p>The script is available in the <a href=https://github.com/kubewarden/utils/blob/main/scripts/psp-to-kubewarden>utils repository</a>
in the Kubewarden GitHub organization. It will download the
migration tool in the working directory and run it over all your PSPs printing
the equivalent Kuberwarden policies' definitions in the standard output. Therefore,
users can redirect the content to a file or to <code>kubectl</code> directly.</p><p>The script will migrate the PSPs defined in <code>kubectl</code> default context.
The Kubewarden policies will be printed to stdout. Thus, the users can
apply it directly or save it for further inspection. Let&rsquo;s take a look at an example:</p><p>In a cluster with the PSP blocking access to host namespaces, blocking privileged containers, not allowing privilege escalation, dropping all containers capabilities, listing the allowed volume types, defining the allowed user and groups to be used, controling the supplemental group applied to volumes and forcing containers to run in a read-only root filesystem:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>policy/v1beta1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PodSecurityPolicy</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>restricted</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>hostNetwork</span>: <span style=color:#66d9ef>false</span>
  <span style=color:#f92672>hostIPC</span>: <span style=color:#66d9ef>false</span>
  <span style=color:#f92672>hostPID</span>: <span style=color:#66d9ef>false</span>
  <span style=color:#f92672>hostPorts</span>:
    - <span style=color:#f92672>min</span>: <span style=color:#ae81ff>80</span>
      <span style=color:#f92672>max</span>: <span style=color:#ae81ff>8080</span>
  <span style=color:#f92672>privileged</span>: <span style=color:#66d9ef>false</span>
  <span style=color:#75715e># Required to prevent escalations to root.</span>
  <span style=color:#f92672>allowPrivilegeEscalation</span>: <span style=color:#66d9ef>false</span>
  <span style=color:#f92672>requiredDropCapabilities</span>:
    - <span style=color:#ae81ff>ALL</span>
  <span style=color:#75715e># Allow core volume types.</span>
  <span style=color:#f92672>volumes</span>:
    - <span style=color:#e6db74>&#39;configMap&#39;</span>
    - <span style=color:#e6db74>&#39;emptyDir&#39;</span>
    - <span style=color:#e6db74>&#39;projected&#39;</span>
    - <span style=color:#e6db74>&#39;secret&#39;</span>
    - <span style=color:#e6db74>&#39;downwardAPI&#39;</span>
    <span style=color:#75715e># Assume that ephemeral CSI drivers &amp; persistentVolumes set up by the cluster admin are safe to use.</span>
    - <span style=color:#e6db74>&#39;csi&#39;</span>
    - <span style=color:#e6db74>&#39;persistentVolumeClaim&#39;</span>
    - <span style=color:#e6db74>&#39;ephemeral&#39;</span>
  <span style=color:#f92672>runAsUser</span>:
    <span style=color:#75715e># Require the container to run without root privileges.</span>
    <span style=color:#f92672>rule</span>: <span style=color:#e6db74>&#39;MustRunAsNonRoot&#39;</span>
  <span style=color:#f92672>seLinux</span>:
    <span style=color:#75715e># This policy assumes the nodes are using AppArmor rather than SELinux.</span>
    <span style=color:#f92672>rule</span>: <span style=color:#e6db74>&#39;RunAsAny&#39;</span>
  <span style=color:#f92672>supplementalGroups</span>:
    <span style=color:#f92672>rule</span>: <span style=color:#e6db74>&#39;MustRunAs&#39;</span>
    <span style=color:#f92672>ranges</span>:
      <span style=color:#75715e># Forbid adding the root group.</span>
      - <span style=color:#f92672>min</span>: <span style=color:#ae81ff>1</span>
        <span style=color:#f92672>max</span>: <span style=color:#ae81ff>65535</span>
  <span style=color:#f92672>fsGroup</span>:
    <span style=color:#f92672>rule</span>: <span style=color:#e6db74>&#39;MustRunAs&#39;</span>
    <span style=color:#f92672>ranges</span>:
      <span style=color:#75715e># Forbid adding the root group.</span>
      - <span style=color:#f92672>min</span>: <span style=color:#ae81ff>1</span>
        <span style=color:#f92672>max</span>: <span style=color:#ae81ff>65535</span>
  <span style=color:#f92672>readOnlyRootFilesystem</span>: <span style=color:#66d9ef>true</span>

</code></pre></div><p>The equivalent Kubewarden policies can be applied directly to a cluster with
Kubewarden installed using the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ ./psp-to-kubewarden | kubectl apply -f -
Warning: policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+
Warning: policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+
clusteradmissionpolicy.policies.kubewarden.io/psp-privileged-82bf2 created
clusteradmissionpolicy.policies.kubewarden.io/psp-readonlyrootfilesystem-b4a55 created
clusteradmissionpolicy.policies.kubewarden.io/psp-hostnamespaces-a25a2 created
clusteradmissionpolicy.policies.kubewarden.io/psp-volumes-cee05 created
clusteradmissionpolicy.policies.kubewarden.io/psp-capabilities-34d8e created
clusteradmissionpolicy.policies.kubewarden.io/psp-usergroup-878b0 created
clusteradmissionpolicy.policies.kubewarden.io/psp-fsgroup-3b08e created
clusteradmissionpolicy.policies.kubewarden.io/psp-defaultallowprivilegeescalation-b7e87 created
</code></pre></div><p>If users want to inspect the policies before applying, it&rsquo;s possible to redirect
the content to a file or review it directly on the console.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ ./psp-to-kubewarden &gt; policies.yaml
$ cat policies.yaml
---
apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  name: psp-privileged-82bf2
spec:
  module: registry://ghcr.io/kubewarden/policies/pod-privileged:v0.1.10
  rules:
    - apiGroups:
        - &#34;&#34;
      apiVersions:
        - v1
      resources:
        - pods
      operations:
        - CREATE
        - UPDATE
  mutating: false
  settings: null

---
apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  name: psp-readonlyrootfilesystem-b4a55
spec:
  module: registry://ghcr.io/kubewarden/policies/readonly-root-filesystem-psp:v0.1.3
  rules:
    - apiGroups:
        - &#34;&#34;
      apiVersions:
        - v1
      resources:
        - pods
      operations:
        - CREATE
        - UPDATE
  mutating: false
  settings: null

---
apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  name: psp-hostnamespaces-a25a2
spec:
  module: registry://ghcr.io/kubewarden/policies/host-namespaces-psp:v0.1.2
  rules:
    - apiGroups:
        - &#34;&#34;
      apiVersions:
        - v1
      resources:
        - pods
      operations:
        - CREATE
        - UPDATE
  mutating: false
  settings:
    allow_host_ipc: false
    allow_host_pid: false
    allow_host_ports:
      - max: 8080
        min: 80
    allow_host_network: false

---
apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  name: psp-volumes-cee05
spec:
  module: registry://ghcr.io/kubewarden/policies/volumes-psp:v0.1.6
  rules:
    - apiGroups:
        - &#34;&#34;
      apiVersions:
        - v1
      resources:
        - pods
      operations:
        - CREATE
        - UPDATE
  mutating: false
  settings:
    allowedTypes:
      - configMap
      - emptyDir
      - projected
      - secret
      - downwardAPI
      - csi
      - persistentVolumeClaim
      - ephemeral

---
apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  name: psp-capabilities-34d8e
spec:
  module: registry://ghcr.io/kubewarden/policies/capabilities-psp:v0.1.9
  rules:
    - apiGroups:
        - &#34;&#34;
      apiVersions:
        - v1
      resources:
        - pods
      operations:
        - CREATE
        - UPDATE
  mutating: false
  settings:
    allowed_capabilities: []
    required_drop_capabilities:
      - ALL

---
apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  name: psp-usergroup-878b0
spec:
  module: registry://ghcr.io/kubewarden/policies/user-group-psp:v0.2.0
  rules:
    - apiGroups:
        - &#34;&#34;
      apiVersions:
        - v1
      resources:
        - pods
      operations:
        - CREATE
        - UPDATE
  mutating: false
  settings:
    run_as_user:
      rule: MustRunAsNonRoot
    supplemental_groups:
      ranges:
        - max: 65535
          min: 1
      rule: MustRunAs

---
apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  name: psp-fsgroup-3b08e
spec:
  module: registry://ghcr.io/kubewarden/policies/allowed-fsgroups-psp:v0.1.4
  rules:
    - apiGroups:
        - &#34;&#34;
      apiVersions:
        - v1
      resources:
        - pods
      operations:
        - CREATE
        - UPDATE
  mutating: false
  settings:
    ranges:
      - max: 65535
        min: 1
    rule: MustRunAs

---
apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  name: psp-defaultallowprivilegeescalation-b7e87
spec:
  module: &gt;-
    registry://ghcr.io/kubewarden/policies/allow-privilege-escalation-psp:v0.1.11
  rules:
    - apiGroups:
        - &#34;&#34;
      apiVersions:
        - v1
      resources:
        - pods
      operations:
        - CREATE
        - UPDATE
  mutating: false
  settings:
    default_allow_privilege_escalation: false

</code></pre></div><blockquote><p><strong>Note</strong>: The policies names are generated by the PSP migration tool used. The
operator may want to change the name to something more meaningful.</p></blockquote><blockquote><p><strong>Warning:</strong> This script works only in Linux x86_64 machines.</p></blockquote><p>The Kubewarden team expects that this will help users migrate from PSPs as soon as possible.
Let us know if you run into issues. We are happy to help!</p><h3 id=references>References</h3><p><a href=https://www.kubewarden.io/blog/2022/01/mutating-policy-behave-as-validating/>Kubewarden policies cover all the Kubernetes Pod Security Policies</a></p><p><a href=https://www.kubewarden.io/blog/2022/05/psp-migration-docs/>Have you migrated your Kubernetes PodSecurityPolicy?</a></p></div><div><ul id=tags></ul></div><div></div></article></section></main><footer><p>&copy; 2024 Kubewarden Project Authors. All rights reserved.
The Linux Foundation has registered trademarks and uses trademarks.
For a list of trademarks of The Linux Foundation, please see our Trademark Usage page:
<a href=https://www.linuxfoundation.org/trademark-usage>https://www.linuxfoundation.org/trademark-usage</a></p></footer><script async src="https://www.googletagmanager.com/gtag/js?id=G-PSW07XK7TM"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-PSW07XK7TM',{anonymize_ip:!0})}</script></body></html>