<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>A new architecture to ease Kubewarden administrators' lives</title><link rel=icon type=image/svg href=/favicon.svg><link rel=mask-icon href=/favicon.svg><link rel=stylesheet type=text/css href=/sass/blog.min.css?1724077050><script async defer src=https://buttons.github.io/buttons.js></script><script type=text/javascript src=//cdn.bizible.com/scripts/bizible.js async></script></head><body><header><div class=sub-header><a href><img src=/images/logo-kubewarden.svg alt=Kubewarden></a>
<a href=#main-menu id=main-menu-toggle class=menu-toggle aria-label="Open main menu"><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><nav id=main-menu class=main-menu aria-label="Main menu"><a href=#main-menu-toggle id=main-menu-close class=menu-close aria-label="Close main menu"><span class=sr-only>Close main menu</span>
<span class="fa fa-close" aria-hidden=true></span></a><h2 id=main-menu-heading class=sr-only>Main menu</h2><ul class=menu><li><a href="https://artifacthub.io/packages/search?kind=13&sort=relevance&page=1" target=_blank class="btn no-bg">Policies</a></li><li><a href=https://charts.kubewarden.io/ target=_blank class="btn no-bg">Helm Charts</a></li><li><a href=https://docs.kubewarden.io/ target=_blank class="btn no-bg">Docs</a></li><li><a href="https://kubernetes.slack.com/?redir=%2Fmessages%2Fkubewarden" target=_blank class="btn no-bg">Slack</a></li><li><a href=https://twitter.com/kubewarden target=_blank class="btn no-bg">Twitter</a></li><li><a href=/#get-in-touch target=_blank class="btn no-bg">Community</a></li><li><a href=/blog target=_blank class="btn no-bg">Blog</a></li><li><a href=https://github.com/kubewarden class="btn github"><img src=/images/icon-github.svg><span>Github</span></a></li></ul></nav><a href=#main-menu-toggle class=backdrop tabindex=-1 aria-hidden=true hidden></a></div></header><link rel=stylesheet href=/css/blog.css><section class=intro><div class=bg-primary><div class="wrap grid-one"><div><h1 style=color:#fff><a href=/blog>The Kubewarden blog</a>
<a href=/blog/index.xml><img src=/images/icon-rss.svg class=fill-white height=20></a></h1></div></div></div></section><main><section class=wrap><article><h1>A new architecture to ease Kubewarden administrators' lives</h1><p>Author: <author>VÃ­ctor Cuadrado Juan</author></p><p>Published: <time>01 Oct 2021</time></p><p>Updated: <time>19 Aug 2024</time></p><div id=blog-post-content><p>We are pleased to announce a new architecture for the Kubewarden stack, in line
with its journey to maturity:</p><p>The introduction of a <strong>PolicyServer</strong> Custom Resource Definition (CRD) which
allows users to describe a policy-server Deployment, together with binding
<strong>ClusterAdmissionPolicies</strong> to a specific <strong>PolicyServer</strong> instance.</p><p>These 2 changes are accompanied by a multitude of improvements to make Kubewarden
more comfortable for Kubernetes Administrators, such as validation for
Kuberwarden Custom Resources, improvements in Helm Charts, Status and
Conditions for <strong>ClusterAdmissionPolicies</strong>.</p><p>For a comprehensive list, see the release notes of
<a href=https://github.com/kubewarden/helm-charts/releases/tag/kubewarden-crds-0.1.0>kubewarden-crds-0.1.0</a>
and
<a href=https://github.com/kubewarden/helm-charts/releases/tag/kubewarden-controller-0.3.0>kubewarden-controller-0.3.0</a>
Helm charts.</p><h2 id=how-does-it-look-like>How does it look like?</h2><p>In previous versions, the Kubewarden Controller instantiated a single Deployment
of policy-server. That policy-server was configured via a ConfigMap, which
contained the Deployment options (image, replicas, &mldr;), and a list of policies
to be loaded, with information on where to pull them from, their configuration
options and so on.</p><p>With the addition of the new <strong>PolicyServer</strong> Custom Resource, administrators
have a better UX, since they can define as many policy servers as they need, and
get to select what PolicyServer each ClusterAdmissionPolicy targets. Let&rsquo;s see a
diagram of the new architecture:</p><figure><img src=/images/how-it-works-kubewarden.svg alt="new architecture diagram"></figure><p>On the diagram, notice the 2 separate PolicyServer Deployments in cyan and mauve
(right), created as specified in the 2 PolicyServer resources (left).</p><p>Each policy server loads different policies &ndash; all ClusterAdmissionPolicies that
target that specific policy server. The new PolicyServer Custom Resource is
cluster-wide, which means that is identifiable by its unique <code>name</code>. Here is an
example of a PolicyServer named <code>tenant-a</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>policies.kubewarden.io/v1alpha2</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PolicyServer</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tenant-a</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>ghcr.io/kubewarden/policy-server:v0.1.10</span>
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>serviceAccountName</span>: <span style=color:#ae81ff>policy-server</span>
</code></pre></div><p>The PolicyServer Custom Resource also accepts an optional
<code>spec.serviceAccountName</code> to be associated with (if not set, as here, the
Namespace default ServiceAccount will be used).</p><p>A ClusterAdmissionPolicy targeting that PolicyServer needs to set
<code>spec.policyServer</code> to <code>tenant-a</code>, as such:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>policies.kubewarden.io/v1alpha2</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterAdmissionPolicy</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>psp-capabilities</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>policyServer</span>: <span style=color:#ae81ff>tenant-a</span>
  <span style=color:#f92672>module</span>: <span style=color:#ae81ff>registry://ghcr.io/kubewarden/policies/psp-capabilities:v0.1.3</span>
  <span style=color:#f92672>rules</span>:
    - <span style=color:#f92672>apiGroups</span>: [<span style=color:#e6db74>&#34;&#34;</span>]
      <span style=color:#f92672>apiVersions</span>: [<span style=color:#e6db74>&#34;v1&#34;</span>]
      <span style=color:#f92672>resources</span>: [<span style=color:#e6db74>&#34;pods&#34;</span>]
      <span style=color:#f92672>operations</span>:
        - <span style=color:#ae81ff>CREATE</span>
        - <span style=color:#ae81ff>UPDATE</span>
  <span style=color:#f92672>mutating</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#f92672>settings</span>:
    <span style=color:#f92672>allowed_capabilities</span>:
      - <span style=color:#ae81ff>CHOWN</span>
    <span style=color:#f92672>required_drop_capabilities</span>:
      - <span style=color:#ae81ff>NET_ADMIN</span>
</code></pre></div><p>For a more in depth dive, have a look at our <a href=https://docs.kubewarden.io/architecture.html>architecture
docs</a>, and the <a href=https://github.com/kubewarden/kubewarden-controller/blob/main/docs/crds/README.asciidoc>Kubewarden CRDs documentation</a>.</p><h2 id=ok-but-what-does-this-mean-for-administrators>Ok, but what does this mean for administrators?</h2><p>With the possibility to use more than one PolicyServer, it is now up to the
Kubernetes administrators on how they want to split and organize policy
evaluations, at the same time that resilience grows.</p><p>While the old architecture was already HA, a noisy tenant/namespace or a
frequently used policy could in the past bring to a crawl the only policy server
and break havoc in the Cluster (as all admission reviews for the cluster went
through it to be screened).</p><p>Now for example, a Kubernetes Administrator can decide to isolate policy
evaluations per tenant/namespace by creating a PolicyServer for each tenant
workload. Or run mission critical policies separately, making the whole
infrastructure more resilient.</p><p>In the future, with an upcoming namespaced AdmissionPolicy Custom Resource,
administrators will be able to give different tenants control over their own
admission policies, reducing administrative overload.</p><p>The new architecture also validates and mutates PolicyServers and
ClusterAdmissionPolicies with dedicated admission controllers, for a better UX.
Which means that administrators can rest comfortably when editing them, as
catastrophic outcomes (such as all policies being dropped by a misconfigured
PolicyServer, leading to DOS against the cluster) can never happen.</p><p>Also, ClusterAdmissionPolicies will, if no <code>spec.policyServer</code> is defined, bind
to the PolicyServer named <code>default</code> (created by the Helm chart). In addition,
<a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/finalizers/>Finalizers</a>
are now added to all Kubewarden Custom Resources, which ensure orderly deletion
by the Kubewarden Controller.</p><p>The inclusion of validating and mutating webhooks for Kuberwarden CRDs means that
the controller webhook server needs to be securely hooked up to the Kubernetes
API. In this case, it means using TLS certificates. We have chosen to integrate
Kuberwarden with <a href=https://cert-manager.io/>cert-manager</a>, to simplify the
installation, and our Helm Chart today comes with the option for automatically
creating and setting up Self-Signed certs, or using your own cert-manager
Issuer.</p><p>For ease of deployment, we have separated the CRDs into its own Helm chart:
<code>kubewarden-crds</code>. This prepares the stack for smoother upgrades in the future.
The Kubewarden Controller and default policy server stay in the
<code>kubewarden-controller</code> Helm chart.</p><p>All of the new changes simplify managing clusters. Which makes Kubewarden use
via <a href=https://fleet.rancher.io/>Fleet</a> more consistent and streamlined.</p><h2 id=a-hands-on-example>A hands-on example</h2><p>Let&rsquo;s install Kubewarden and secure our cluster against privileged pods with a
simple policy.</p><h3 id=installing-kubewarden>Installing Kubewarden</h3><p>Follow this example:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.5.3/cert-manager.yaml
$ kubectl wait --for=condition=Available deployment --timeout=2m -n cert-manager --all
$ helm repo add kubewarden https://charts.kubewarden.io
$ helm install --create-namespace -n kubewarden kubewarden-crds kubewarden/kubewarden-crds
$ helm install --wait -n kubewarden kubewarden-controller kubewarden/kubewarden-controller
</code></pre></div><p>This will install <a href=https://cert-manager.io>cert-manager</a>, a dependency of
Kubewarden, and then install the <code>kubewarden-crds</code> and <code>kubewarden-controller</code>
Helm charts in the default configuration (which includes self-signed TLS certs).
Shortly after, you will have the Kubewarden Controller running and one
PolicyServer, named <code>default</code>, on the <code>kubewarden</code> namespace:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ kubectl get policyservers
NAME      AGE
default   38s
</code></pre></div><p>The default configuration values should be good enough for the majority of
deployments (all options are documented <a href=https://charts.kubewarden.io/#configuration>here</a>).</p><p>Now, you can use Kubewarden, with Go, Rust, Swift, Open Policy Agent and
Gatekeeper policies, as you are used to.</p><p>Let&rsquo;s deploy our own policy-server named <code>my-policy-server</code>, and a Kubewarden
Policy based on the
<a href=https://github.com/kubewarden/pod-privileged-policy>pod-privileged</a> policy, to
be scheduled in that specific policy-server:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ kubectl apply -f - &lt;&lt;EOF
---
apiVersion: policies.kubewarden.io/v1alpha2
kind: ClusterAdmissionPolicy
metadata:
  name: privileged-pods
spec:
  policyServer: my-policy-server
  module: registry://ghcr.io/kubewarden/policies/pod-privileged:v0.1.9
  rules:
    - apiGroups: [&#34;&#34;]
      apiVersions: [&#34;v1&#34;]
      resources: [&#34;pods&#34;]
      operations:
        - CREATE
        - UPDATE
  mutating: false
---
apiVersion: policies.kubewarden.io/v1alpha2
kind: PolicyServer
metadata:
  name: my-policy-server
spec:
  image: ghcr.io/kubewarden/policy-server:v0.1.10
  replicas: 1
  serviceAccountName: policy-server
EOF
</code></pre></div><hr><blockquote><p>Note for Windows (<a href=https://rancherdesktop.io>Rancher Desktop</a>) users:</p><p>The above uses Linux shell syntax and won&rsquo;t work on Windows PowerShell
or <a href=https://github.com/Microsoft/Terminal>Windows Terminal</a>.</p><p>You can use this command instead:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>kubectl apply -f https://www.kubewarden.io/blog/2021/10/new-architecture/deploy-pod-privileged.yaml
</code></pre></div></blockquote><hr><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ kubectl get policyservers
NAME               AGE
default            1m12s
my-policy-server   29s
</code></pre></div><p>While the new Deployment for the new PolicyServer is still being deployed, the
policy will be marked as <code>unschedulable</code>, and move to <code>pending</code> once we are
waiting for the PolicyServer to accept connections:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ kubectl get clusteradmissionpolicies
NAME              POLICY SERVER      MUTATING   STATUS
privileged-pods   my-policy-server   false      pending
</code></pre></div><p>We can wait some seconds for the policy server to be up, and the policy to be active:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ kubectl wait --for=condition=PolicyActive clusteradmissionpolicy/privileged-pods
clusteradmissionpolicy.policies.kubewarden.io/privileged-pods condition met

$ kubectl get clusteradmissionpolicies
NAME              POLICY SERVER      MUTATING   STATUS
privileged-pods   my-policy-server   false      active
</code></pre></div><p>Now if we try to create a Pod with at least one privileged container, it will
not be allowed:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ kubectl apply -f - &lt;&lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: privileged-pod
spec:
  containers:
    - name: nginx
      image: nginx:latest
      securityContext:
          privileged: true
EOF

Error from server: error when creating &#34;STDIN&#34;: admission webhook &#34;privileged-pods.kubewarden.admission&#34; denied the request: User &#39;youruser:yourrole&#39; cannot schedule privileged containers
</code></pre></div><hr><blockquote><p>Here the same command for Windows (Rancher Desktop):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>kubectl apply -f https://www.kubewarden.io/blog/2021/10/new-architecture/create-privileged-pod.yaml
</code></pre></div></blockquote><hr><h1 id=foreword>Foreword</h1><p>The new Kubewarden stack, with the new cluster-wide PolicyServer resource,
allows fine-tuning of policies, and at the same time makes the life of
administrators easier with CR validations, workflow simplifications, and
separation of concerns.</p><p>We hope you enjoy Kubewarden. We have many ideas about how to expand and improve
the project, and we would like to hear what you would like to see in the
future: don&rsquo;t hesitate to open an issue in any of the
<a href=https://github.com/kubewarden>github.com/kubewarden</a> projects or get in
contact in the <a href=https://kubernetes.slack.com/archives/C01T3GTC3L7>#kubewarden Slack channel</a>!</p><p>Stay tuned for more!</p></div><div><ul id=tags></ul></div><div></div></article></section></main><footer><p>&copy; 2024 Kubewarden Project Authors. All rights reserved.
The Linux Foundation has registered trademarks and uses trademarks.
For a list of trademarks of The Linux Foundation, please see our Trademark Usage page:
<a href=https://www.linuxfoundation.org/trademark-usage>https://www.linuxfoundation.org/trademark-usage</a></p></footer><script async src="https://www.googletagmanager.com/gtag/js?id=G-PSW07XK7TM"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-PSW07XK7TM',{anonymize_ip:!0})}</script></body></html>